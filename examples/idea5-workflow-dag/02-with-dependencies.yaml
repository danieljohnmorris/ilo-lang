name: process
input:
  order: order
output: result order, text

steps:
  validate:
    call: validate
    args:
      addr: $.order.addr
    catch:
      return:
        error: "Invalid shipping address"

  ship:
    call: shipping
    args:
      weight: $.order.weight
      dest: $.order.addr.country

  disc:
    call: discount
    args:
      subtotal: $.order.subtotal
      code: $.order.code

  total:
    expr: "$.order.subtotal - ${disc} + ${ship}"

  done:
    return:
      ok:
        merge: $.order
        set:
          total: ${total}
          cost: ${ship}
