name: checkout
input:
  payment-id: text
  amount: number
  items: list item
output: result receipt, text

steps:
  reserve:
    call: reserve
    args:
      items: $.items
    catch:
      return:
        error: "Inventory unavailable: ${error}"

  charge:
    call: charge
    args:
      payment-id: $.payment-id
      amount: $.amount
    catch:
      compensate:
        - call: release
          args:
            reservation-id: ${reserve}
      return:
        error: "Payment failed: ${error}"

  order-id:
    call: make-id

  done:
    return:
      ok:
        order-id: ${order-id}
        charge-id: ${charge}
        reservation-id: ${reserve}
