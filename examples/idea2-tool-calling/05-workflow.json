{
  "function": "checkout",
  "input": {"payment-id": "text", "amount": "number", "items": "list item"},
  "output": "result receipt text",
  "steps": [
    {
      "let": "rid",
      "call": "reserve",
      "args": {"items": "$input.items"},
      "on-error": {"return": {"error": "Inventory unavailable: $error"}}
    },
    {
      "let": "cid",
      "call": "charge",
      "args": {"payment-id": "$input.payment-id", "amount": "$input.amount"},
      "on-error": {
        "compensate": [{"call": "release", "args": {"reservation-id": "$rid"}}],
        "return": {"error": "Payment failed: $error"}
      }
    },
    {
      "let": "oid",
      "call": "make-id",
      "args": {}
    },
    {
      "return": {"ok": {"order-id": "$oid", "charge-id": "$cid", "reservation-id": "$rid"}}
    }
  ]
}
