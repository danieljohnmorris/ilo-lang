{
  "function": "process",
  "input": {"order": "order"},
  "output": "result order text",
  "deps": ["validate", "shipping", "discount"],
  "steps": [
    {"let": "valid", "call": "validate", "args": {"addr": "$input.order.addr"}},
    {"if": {"not": "$valid"}, "return": {"error": "Invalid shipping address"}},
    {"let": "ship", "call": "shipping", "args": {"weight": "$input.order.weight", "dest": "$input.order.addr.country"}},
    {"let": "disc", "call": "discount", "args": {"subtotal": "$input.order.subtotal", "code": "$input.order.code"}},
    {"let": "final", "expr": {"+": [{"-": ["$input.order.subtotal", "$disc"]}, "$ship"]}},
    {"return": {"ok": {"$merge": ["$input.order", {"total": "$final", "cost": "$ship"}]}}}
  ]
}
